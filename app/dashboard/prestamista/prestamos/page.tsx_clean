'use client';

import { useState } from 'react';
import {
  Box,
  Typography,
  Button,
  Paper,
  Alert,
  Card,
  CardContent,
  Divider,
  FormControl,
  InputLabel,
  Select,
  MenuItem
} from '@mui/material';
import {
  Add,
  AccountBalance,
  TrendingUp,
  Assessment,
  MonetizationOn,
  Warning,
  Download,
  BarChart
} from '@mui/icons-material';
import { useRouter } from 'next/navigation';
import { StatsCard } from '@/components/dashboard/StatsCard';
import { useLoans } from '@/hooks/useLoans';

// Mock data
const mockAnalyticsData = {
  portfolioHealth: {
    tasaRecuperacion: '87.3',
    promedioVencimientos: '12',
    rentabilidadMensual: '15.2',
  },
  monthlyTrends: [
    { month: 'Febrero 2025', prestamos: 8, monto: 150000, recuperado: 135000 },
    { month: 'Enero 2025', prestamos: 12, monto: 220000, recuperado: 198000 },
    { month: 'Diciembre 2024', prestamos: 15, monto: 280000, recuperado: 252000 },
    { month: 'Noviembre 2024', prestamos: 10, monto: 185000, recuperado: 166500 },
    { month: 'Octubre 2024', prestamos: 18, monto: 320000, recuperado: 288000 },
    { month: 'Septiembre 2024', prestamos: 22, monto: 410000, recuperado: 369000 },
  ],
  topClients: [
    { name: 'MarÃ­a GonzÃ¡lez', prestamos: 3, montoTotal: 45000, pagosAlDia: 3 },
    { name: 'Carlos RodrÃ­guez', prestamos: 2, montoTotal: 30000, pagosAlDia: 2 },
    { name: 'Ana LÃ³pez', prestamos: 4, montoTotal: 60000, pagosAlDia: 3 },
    { name: 'Luis MartÃ­n', prestamos: 1, montoTotal: 15000, pagosAlDia: 1 },
    { name: 'Sofia PÃ©rez', prestamos: 2, montoTotal: 25000, pagosAlDia: 1 },
  ],
};

export default function PrestamosAnalyticsPage() {
  const router = useRouter();
  const { loans, isLoading, error, getTotalLoans } = useLoans();
  // Simplified state - removed complex filters

  const totalLoans = getTotalLoans();
  const totalAmount = loans.reduce((sum, loan) => sum + loan.amount, 0);
  const activeLoans = loans.filter((loan) => loan.status === 'ACTIVE').length;
  const completedLoans = loans.filter(
    (loan) => loan.status === 'COMPLETED'
  ).length;
  const overdueLoans = loans.filter(
    (loan) => loan.status === 'DEFAULTED'
  ).length;
  const avgLoanAmount = totalLoans > 0 ? totalAmount / totalLoans : 0;
  const recoveryRate = totalLoans > 0 ? (completedLoans / totalLoans) * 100 : 0;

  const handleCreateLoan = () => {
    router.push('/dashboard/prestamista/prestamos/nuevo');
  };

  const handleGoToCobros = () => {
    router.push('/dashboard/prestamista/cobros');
  };

  return (
    <Box sx={{ p: 3 }}>
      {/* Header */}
      <Box
        sx={{
          display: 'grid',
          gridTemplateColumns: { xs: '1fr', sm: '1fr auto' },
          gap: 3,
          mb: 4,
        }}
      >
        <Box>
          <Typography
            variant='h4'
            component='h1'
            gutterBottom
          >
            AnÃ¡lisis de Cartera
          </Typography>
          <Typography
            variant='body1'
            color='text.secondary'
          >
            Dashboard analÃ­tico con reportes histÃ³ricos y mÃ©tricas de rendimiento
          </Typography>
        </Box>

        <Box
          sx={{
            display: 'flex',
            gap: 2,
            flexDirection: { xs: 'column', sm: 'row' },
          }}
        >
          <Button
            variant='outlined'
            startIcon={<Add />}
            onClick={handleCreateLoan}
            sx={{ width: { xs: '100%', sm: 'auto' } }}
          >
            Nuevo PrÃ©stamo
          </Button>
          <Button
            variant='contained'
            color='warning'
            onClick={handleGoToCobros}
            sx={{ width: { xs: '100%', sm: 'auto' } }}
          >
            Ir a Cobros
          </Button>
        </Box>
      </Box>

      {/* Error Alert */}
      {error && (
        <Alert
          severity='error'
          sx={{ mb: 3 }}
        >
          {error}
        </Alert>
      )}

      {/* Stats Grid Simplificada */}
      <Box
        sx={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
          gap: 3,
          mb: 4,
        }}
      >
        <StatsCard
          title='Cartera Total'
          value={totalLoans}
          subtitle={`$${totalAmount.toLocaleString()} prestados`}
          icon={<AccountBalance />}
          color='primary'
          isLoading={isLoading}
        />
        <StatsCard
          title='PrÃ©stamo Promedio'
          value={`$${avgLoanAmount.toLocaleString()}`}
          subtitle='monto promedio por prÃ©stamo'
          icon={<MonetizationOn />}
          color='primary'
          isLoading={isLoading}
        />
      </Box>

      {/* Resumen Ejecutivo Simplificado */}
      <Box sx={{ display: 'grid', gap: 4 }}>
        <Paper sx={{ p: 3 }}>
          <Typography
            variant='h6'
            gutterBottom
          >
            ðŸ“Š Resumen Ejecutivo - EN DESARROLLO
          </Typography>
          <Divider sx={{ mb: 3 }} />

          <Alert severity='info' sx={{ mb: 3 }}>
            <Typography
              variant='subtitle2'
              gutterBottom
            >
              ðŸš§ PrÃ³ximamente disponible
            </Typography>
            <Typography variant='body2'>
              Esta secciÃ³n estarÃ¡ disponible cuando conectemos los datos reales del backend.
            </Typography>
          </Alert>

          <Box sx={{ display: 'grid', gap: 2 }}>
            <Typography variant='subtitle2' color='primary'>
              Funcionalidades en desarrollo:
            </Typography>
            
            <Box component='ul' sx={{ pl: 3, m: 0 }}>
              <Typography component='li' variant='body2'>
                ðŸ“ˆ AnÃ¡lisis de rendimiento por perÃ­odo
              </Typography>
              <Typography component='li' variant='body2'>
                ðŸ“Š Reportes detallados de cartera
              </Typography>
              <Typography component='li' variant='body2'>
                ðŸ“‹ MÃ©tricas avanzadas de cobros
              </Typography>
              <Typography component='li' variant='body2'>
                ðŸŽ¯ KPIs personalizados por prestamista
              </Typography>
              <Typography component='li' variant='body2'>
                ðŸ“‰ Tendencias histÃ³ricas y proyecciones
              </Typography>
            </Box>
          </Box>
        </Paper>
      </Box>
    </Box>
  );
}